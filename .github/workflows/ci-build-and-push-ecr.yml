name: Build and Push Images to ECR

on:
  # 手動実行で対象サービスとタグを選択する
  workflow_dispatch:
    inputs:
      service:
        description: "対象サービス"
        required: true
        type: choice
        options:
          - frontend
          - backend
          - database
      image_tag:
        description: "イメージタグ"
        required: true
        default: "latest"
        type: string

permissions:
  id-token: write
  contents: read

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    env:
      AWS_REGION: ap-northeast-1
      AWS_ACCOUNT_ID: "636965820260"
      AWS_ROLE_TO_ASSUME: arn:aws:iam::636965820260:role/github-actions-ecr-push-role
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      # OIDC + AssumeRole で一時認証情報を取得
      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ env.AWS_ROLE_TO_ASSUME }}
          aws-region: ${{ env.AWS_REGION }}

      # AWS公式ActionでECRへログイン
      - name: Login to Amazon ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v2

      - name: Resolve build settings
        id: vars
        run: |
          set -euo pipefail
          SERVICE="${{ github.event.inputs.service }}"
          IMAGE_TAG="${{ github.event.inputs.image_tag }}"

          case "${SERVICE}" in
            frontend)
              REPO_NAME="ai-knowledge-stock/frontend"
              BUILD_CONTEXT="./frontend"
              DOCKERFILE_PATH="./frontend/Dockerfile"
              ;;
            backend)
              REPO_NAME="ai-knowledge-stock/backend"
              BUILD_CONTEXT="./backend"
              DOCKERFILE_PATH="./backend/Dockerfile"
              ;;
            database)
              REPO_NAME="ai-knowledge-stock/database"
              BUILD_CONTEXT="./database"
              DOCKERFILE_PATH="./database/Dockerfile"
              ;;
            *)
              echo "不正な service 入力です: ${SERVICE}" >&2
              exit 1
              ;;
          esac

          ECR_REGISTRY="${AWS_ACCOUNT_ID}.dkr.ecr.${AWS_REGION}.amazonaws.com"
          IMAGE_URI="${ECR_REGISTRY}/${REPO_NAME}:${IMAGE_TAG}"

          echo "repo_name=${REPO_NAME}" >> "${GITHUB_OUTPUT}"
          echo "build_context=${BUILD_CONTEXT}" >> "${GITHUB_OUTPUT}"
          echo "dockerfile_path=${DOCKERFILE_PATH}" >> "${GITHUB_OUTPUT}"
          echo "image_uri=${IMAGE_URI}" >> "${GITHUB_OUTPUT}"

      # AWSの公式テンプレート方針に合わせてdocker build / pushを実行
      - name: Build, tag, and push image to Amazon ECR
        run: |
          docker build \
            -f "${{ steps.vars.outputs.dockerfile_path }}" \
            -t "${{ steps.vars.outputs.image_uri }}" \
            "${{ steps.vars.outputs.build_context }}"
          docker push "${{ steps.vars.outputs.image_uri }}"
          echo "Pushed image: ${{ steps.vars.outputs.image_uri }}"
