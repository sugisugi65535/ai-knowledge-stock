#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "${ROOT_DIR}"

if ! command -v aws >/dev/null 2>&1; then
  echo "aws CLI がインストールされていません。" >&2
  exit 1
fi

if [[ ! -f "env/env.database" ]]; then
  echo "env/env.database が存在しないため value 投入できません。" >&2
  exit 1
fi

set -a
source "config/infra.conf"
source "env/env.database"
set +a

POSTGRES_USER_SECRET_NAME="ai-knowledge-stock/postgres/user"
POSTGRES_PASSWORD_SECRET_NAME="ai-knowledge-stock/postgres/password"
POSTGRES_DB_SECRET_NAME="ai-knowledge-stock/postgres/db"

require_value() {
  local key="$1"
  local value="$2"
  if [[ -z "${value}" ]]; then
    echo "${key} が未設定です。" >&2
    exit 1
  fi
}

put_secret_value() {
  local secret_name="$1"
  local secret_value="$2"

  if ! aws secretsmanager describe-secret --region "${AWS_REGION}" --secret-id "${secret_name}" >/dev/null 2>&1; then
    echo "Secrets Manager key が存在しません: ${secret_name}" >&2
    echo "先に Terraform apply で key を作成してください。" >&2
    exit 1
  fi

  aws secretsmanager put-secret-value \
    --region "${AWS_REGION}" \
    --secret-id "${secret_name}" \
    --secret-string "${secret_value}" >/dev/null
}

require_value "POSTGRES_USER" "${POSTGRES_USER:-}"
require_value "POSTGRES_PASSWORD" "${POSTGRES_PASSWORD:-}"
require_value "POSTGRES_DB" "${POSTGRES_DB:-}"

put_secret_value "${POSTGRES_USER_SECRET_NAME}" "${POSTGRES_USER}"
put_secret_value "${POSTGRES_PASSWORD_SECRET_NAME}" "${POSTGRES_PASSWORD}"
put_secret_value "${POSTGRES_DB_SECRET_NAME}" "${POSTGRES_DB}"

echo "Secrets Manager への value 投入が完了しました。"
