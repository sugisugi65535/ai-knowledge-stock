#!/usr/bin/env bash
set -euo pipefail

ROOT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
cd "${ROOT_DIR}"

ensure_docker_daemon() {
  if docker info >/dev/null 2>&1; then
    return
  fi

  echo "Dockerデーモンが停止しているため起動を試みます..."
  if command -v service >/dev/null 2>&1; then
    sudo service docker start >/dev/null 2>&1 || true
  fi

  for _ in $(seq 1 15); do
    if docker info >/dev/null 2>&1; then
      return
    fi
    sleep 1
  done

  echo "Dockerデーモンの起動を確認できませんでした。" >&2
  exit 1
}

create_if_missing() {
  local target_file="$1"
  local template="$2"
  if [[ -f "${target_file}" ]]; then
    return
  fi

  mkdir -p "$(dirname "${target_file}")"
  printf "%s\n" "${template}" > "${target_file}"
}

create_env_files() {
  create_if_missing "env/env.frontend" "# frontend secret env"
  create_if_missing "env/env.backend" "# backend secret env"
  create_if_missing "env/env.infra" "# infra secret env"

  if [[ ! -f "env/env.database" ]]; then
    read -r -p "POSTGRES_USER を入力してください: " POSTGRES_USER
    read -r -p "POSTGRES_PASSWORD を入力してください: " POSTGRES_PASSWORD
    read -r -p "POSTGRES_DB を入力してください: " POSTGRES_DB
    cat > env/env.database <<EOF
POSTGRES_USER=${POSTGRES_USER}
POSTGRES_PASSWORD=${POSTGRES_PASSWORD}
POSTGRES_DB=${POSTGRES_DB}
EOF
  fi
}

load_compose_env() {
  set -a
  source "config/common.conf"
  source "config/frontend.conf"
  source "config/backend.conf"
  source "config/database.config"
  source "config/infra.conf"
  source "env/env.frontend"
  source "env/env.backend"
  source "env/env.database"
  source "env/env.infra"
  set +a
}

ensure_docker_daemon
create_env_files
load_compose_env

docker compose -f docker/compose.local.yml up -d --build
